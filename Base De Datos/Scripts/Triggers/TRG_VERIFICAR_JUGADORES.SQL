CREATE OR REPLACE TRIGGER TRG_VERIFICAR_WILDCARD_1
FOR INSERT OR UPDATE ON EQUIPOS_JUGADORES
COMPOUND TRIGGER

  -- Declarar variables globales para el trigger
  CANT_WILDCARDS NUMBER(2);
  CANT_HABITUALES NUMBER;
  NEW_TIPO_JUGADOR VARCHAR(20);

BEFORE EACH ROW IS
BEGIN

  --SELECT DE LA CANTIDAD DE JUGADORES DE TIPO WILDCARD EN EL EQUIPO QUE SE QUIERE INSERTAR, METEMOS EL RESULTADO EN LA VARIABLE CANT_WILDCARDS.
  SELECT COUNT(*) INTO CANT_WILDCARDS FROM EQUIPOS_JUGADORES
    WHERE ID_EQUIPO = :NEW.ID_EQUIPO AND ID_JUGADOR IN (SELECT ID_JUGADOR FROM JUGADORES WHERE TIPO_JUGADOR = 'WILDCARD');
    
  SELECT COUNT(*) INTO CANT_HABITUALES FROM EQUIPOS_JUGADORES
    WHERE ID_EQUIPO = :NEW.ID_EQUIPO AND ID_JUGADOR IN (SELECT ID_JUGADOR FROM JUGADORES WHERE TIPO_JUGADOR = 'HABITUAL');
    
  SELECT TIPO_JUGADOR INTO NEW_TIPO_JUGADOR FROM JUGADORES WHERE ID_JUGADOR = :NEW.ID_JUGADOR; 
  --SI LA VARIABLE ES =2 Y EL TIPO DE JUGADOR ES WILDCARD SACAMOS UN ERROR POR PANTALLA.
END BEFORE EACH ROW;
AFTER EACH ROW IS
BEGIN
    IF NEW_TIPO_JUGADOR = 'WILDCARD' THEN
        IF CANT_WILDCARDS = 2 THEN
            RAISE_APPLICATION_ERROR(-20001, 'NO SE PUEDEN TENER MAS DE 2 JUGADORES DE TIPO WILDCARD');
        END IF;
    ELSE
        IF CANT_HABITUALES = 8 THEN
            RAISE_APPLICATION_ERROR(-20001, 'NO SE PUEDEN TENER MAS DE 8 JUGADORES DE TIPO HABITUAL');
        END IF;
    END IF;
END AFTER EACH ROW;  
END TRG_VERIFICAR_WILDCARD_1;


/* INSERT PARA LAS PRUEBAS

INSERT INTO EQUIPOS_JUGADORES VALUES (1,1,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,2,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,3,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,4,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,6,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,8,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,9,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,10,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);

ERROR Nº1 [MÁS DE 8 HABITUALES]
---------------------------------------

INSERT INTO EQUIPOS_JUGADORES VALUES (1,14,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000)
Informe de error -
ORA-20001: NO SE PUEDEN TENER MAS DE 2 JUGADORES DE TIPO WILDCARD
ORA-06512: en "EQDAW04.TRG_VERIFICAR_WILDCARD_1", línea 25
ORA-04088: error durante la ejecución del disparador 'EQDAW04.TRG_VERIFICAR_WILDCARD_1'


INSERT INTO EQUIPOS_JUGADORES VALUES (1,5,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);
INSERT INTO EQUIPOS_JUGADORES VALUES (1,7,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000);


ERROR Nº2 [MÁS DE 2 WILDCARDS]
--------------------------------------

INSERT INTO EQUIPOS_JUGADORES VALUES (1,18,200,TO_DATE('17/04/2022', 'DD/MM/YYYY'),TO_DATE('20/04/2022', 'DD/MM/YYYY'), 2000000)
Informe de error -
ORA-20001: NO SE PUEDEN TENER MAS DE 8 JUGADORES DE TIPO HABITUAL
ORA-06512: en "EQDAW04.TRG_VERIFICAR_WILDCARD_1", línea 29
ORA-04088: error durante la ejecución del disparador 'EQDAW04.TRG_VERIFICAR_WILDCARD_1'

*/