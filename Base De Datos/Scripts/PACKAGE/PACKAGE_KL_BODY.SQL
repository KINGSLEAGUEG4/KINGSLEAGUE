-- EN JAVA IRIA EN LA PARTE DE ADMINISTRACION DE BASE DE DATOS DEL USUARIO ADMIN
create or replace PACKAGE BODY KL_CALENDARIO AS

    PROCEDURE GENERAR_CALENDARIO
    AS
        V_CONTADOR INTEGER;
        V_CONTADOR_2 INTEGER;
        V_ID_EQUIPO_LOCAL EQUIPOS.ID_EQUIPO%TYPE;
        V_ID_EQUIPO_VISITANTE EQUIPOS.ID_EQUIPO%TYPE;
        V_ID_PARTIDO PARTIDOS.ID_PARTIDO%TYPE;
        V_HORA_PARTIDO VARCHAR2(5) := '16:00';
        V_FECHA_JORNADA DATE := TO_DATE('01/01/2023', 'DD/MM/YYYY');
        V_ID_JORNADA NUMBER := 0;
        V_NUM_ENFRENTADOS NUMBER;
        V_ID_TEMPORADA NUMBER;
        V_NUM_PARTIDOS NUMBER;
        V_ID_PARTIDO_MAX NUMBER;
    BEGIN
        -- CREAR LA NUEVA TEMPORADA
        INSERT INTO TEMPORADAS(FECHA_INICIO, FECHA_FIN, PERIODO, ESTADO)
        VALUES(SYSDATE, SYSDATE + 120, 'INV', 'CERRADO');
        
        SELECT ID_TEMPORADA INTO V_ID_TEMPORADA 
        FROM TEMPORADAS 
        WHERE ROWNUM = 1
        ORDER BY ID_TEMPORADA DESC;
        -- CREAR LAS JORNADAS
        
        FOR NUM_JOR IN 1..11 LOOP
            -- GENERANDO LA JORNADA
            INSERT INTO JORNADAS(ID_TEMPORADA, NUM_JORNADA, FECHA)
            VALUES (V_ID_TEMPORADA, NUM_JOR, V_FECHA_JORNADA);
            V_FECHA_JORNADA := V_FECHA_JORNADA + 7;
        END LOOP;
        
        
        SELECT MIN(ID_JORNADA) INTO V_ID_JORNADA 
        FROM JORNADAS
        WHERE ID_TEMPORADA = V_ID_TEMPORADA;
        -- CREAR LOS ENFRENTAMIENTOS
        V_NUM_ENFRENTADOS := 1;
        FOR EQUIPO_LOCAL IN (SELECT * FROM EQUIPOS) LOOP
            SELECT MIN(ID_JORNADA) INTO V_ID_JORNADA 
            FROM JORNADAS
            WHERE ID_TEMPORADA = V_ID_TEMPORADA;
            
            
            
            FOR EQUIPO_VISITANTE IN (SELECT * FROM EQUIPOS) LOOP
                
                IF EQUIPO_LOCAL.ID_EQUIPO <> EQUIPO_VISITANTE.ID_EQUIPO THEN
                    
                    SELECT COUNT(P.ID_PARTIDO) INTO V_CONTADOR
                    FROM PARTIDOS P
                    WHERE (P.ID_PARTIDO IN (SELECT ID_PARTIDO 
                                            FROM PARTIDOS 
                                            WHERE ID_EQUIPO_LOCAL = EQUIPO_LOCAL.ID_EQUIPO 
                                            AND ID_PARTIDO IN (SELECT ID_PARTIDO FROM PARTIDOS WHERE ID_EQUIPO_VISITANTE = EQUIPO_VISITANTE.ID_EQUIPO))
                    OR P.ID_PARTIDO IN (SELECT ID_PARTIDO 
                                        FROM PARTIDOS 
                                        WHERE ID_EQUIPO_VISITANTE = EQUIPO_LOCAL.ID_EQUIPO 
                                        AND ID_PARTIDO IN (SELECT ID_PARTIDO FROM PARTIDOS WHERE ID_EQUIPO_LOCAL = EQUIPO_VISITANTE.ID_EQUIPO)))
                    AND p.id_jornada IN (SELECT ID_JORNADA FROM JORNADAS WHERE ID_TEMPORADA = (SELECT MAX(ID_TEMPORADA) FROM TEMPORADAS));

                    IF V_CONTADOR = 0 /*AND V_EQ1_JOR = 0 AND V_EQ2_JOR = 0*/ THEN
                        V_ID_EQUIPO_LOCAL := EQUIPO_LOCAL.ID_EQUIPO;
                        V_ID_EQUIPO_VISITANTE := EQUIPO_VISITANTE.ID_EQUIPO;

                        INSERT INTO PARTIDOS (TIPO_PARTIDO, HORA, ID_JORNADA, ID_EQUIPO_LOCAL, ID_EQUIPO_VISITANTE, GOLES_LOCAL, GOLES_VISITANTE) 
                        VALUES ('FR', V_HORA_PARTIDO,V_ID_JORNADA, V_ID_EQUIPO_LOCAL, V_ID_EQUIPO_VISITANTE, NULL, NULL);
                        
                        V_ID_JORNADA := V_ID_JORNADA + 1;
                            
                    END IF;
                END IF;
            END LOOP;
        END LOOP;    

        SELECT MIN(ID_PARTIDO) INTO V_ID_PARTIDO
        FROM PARTIDOS
        WHERE ID_JORNADA IN (SELECT ID_JORNADA FROM JORNADAS WHERE ID_TEMPORADA = V_ID_TEMPORADA);
        
        V_ID_PARTIDO_MAX := V_ID_PARTIDO + 65;
        
        FOR i IN V_ID_PARTIDO..V_ID_PARTIDO_MAX LOOP
            UPDATE PARTIDOS
            SET ID_JORNADA = 14 + MOD((i - 1), 11) + 1
            WHERE ID_PARTIDO = i;
        END LOOP;
        COMMIT;
    END GENERAR_CALENDARIO;

    PROCEDURE VER_ENFRENTAMIENTOS
    (C_CURSOR OUT TCURSOR)
    AS
    BEGIN
        OPEN C_CURSOR FOR
                SELECT P.ID_PARTIDO, EL.NOMBRE AS LOCAL, EV.NOMBRE AS VISITANTE, P.ID_JORNADA, P.HORA
                FROM PARTIDOS P, EQUIPOS EL, EQUIPOS EV
                WHERE P.ID_EQUIPO_LOCAL = EL.ID_EQUIPO AND P.ID_EQUIPO_VISITANTE = EV.ID_EQUIPO
                AND P.ID_JORNADA IN (SELECT ID_JORNADA FROM JORNADAS WHERE ID_TEMPORADA = (SELECT max(id_temporada) from temporadas))
                ORDER BY P.ID_JORNADA, P.ID_PARTIDO;
    END VER_ENFRENTAMIENTOS;
END KL_CALENDARIO;